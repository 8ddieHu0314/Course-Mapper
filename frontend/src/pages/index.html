<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Course Mapper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: #1f2933;
      color: #f9fafb;
      padding: 0.8rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.1rem;
    }

    nav a {
      color: #e5e7eb;
      text-decoration: none;
      margin-left: 1rem;
      font-size: 0.95rem;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .sidebar {
      width: 320px;
      max-width: 100%;
      padding: 1rem;
      border-right: 1px solid #e5e7eb;
      background: #f9fafb;
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 1rem;
      margin-bottom: 0.6rem;
    }

    .sidebar p {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      color: #4b5563;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 0.3rem;
    }

    select {
      width: 100%;
      min-height: 160px;
      padding: 0.3rem;
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }

    button {
      display: inline-block;
      padding: 0.5rem 0.9rem;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      cursor: pointer;
    }

    button:disabled {
      background: #9ca3af;
      cursor: default;
    }

    button:hover:not(:disabled) {
      background: #1d4ed8;
    }

    .note {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.5rem;
    }

    #map {
      flex: 1;
      min-width: 0;
      height: 100%;
    }

    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
      }
      #map {
        height: 60vh;
      }
    }
  </style>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      // Not logged in → send to login page
      window.location.href = "login.html";
    } else {
      console.log("Logged in as:", user.email);
      // you can show UI or fetch user-specific data here
    }
  });
</script>
  <!-- Replace YOUR_API_KEY_HERE with your actual Google Maps JavaScript API key -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE&callback=initMap"
    async
    defer
  ></script>

  <script>
    // ---- Simple "database" of courses and locations ----
    // You can swap these out for real building coordinates later.
    const COURSE_DATA = [
      {
        id: "course1",
        name: "MATH 1910 - Building A",
        lat: 42.4470,
        lng: -76.4840,
      },
      {
        id: "course2",
        name: "CS 2110 - Building B",
        lat: 42.4463,
        lng: -76.4825,
      },
      {
        id: "course3",
        name: "CS 3110 - Building C",
        lat: 42.4481,
        lng: -76.4812,
      },
      {
        id: "course4",
        name: "PHYS 2213 - Building D",
        lat: 42.4490,
        lng: -76.4835,
      },
      {
        id: "course5",
        name: "CHEM 2090 - Building E",
        lat: 42.4468,
        lng: -76.4852,
      },
    ];

    let map;
    let directionsService;
    let directionsRenderer;
    let markers = [];

    // Called automatically by Google Maps when the API script loads
    function initMap() {
      // Initial center roughly over the "campus"
      const initialCenter = { lat: COURSE_DATA[0].lat, lng: COURSE_DATA[0].lng };

      map = new google.maps.Map(document.getElementById("map"), {
        center: initialCenter,
        zoom: 16,
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true, // we'll draw our own markers
      });

      populateCourseSelect();
      document.getElementById("showRouteBtn").disabled = false;
    }

    // Populate the <select> with course options
    function populateCourseSelect() {
      const select = document.getElementById("courseSelect");
      COURSE_DATA.forEach((course) => {
        const option = document.createElement("option");
        option.value = course.id;
        option.textContent = course.name;
        select.appendChild(option);
      });
    }

    // Get course objects for user-selected IDs (preserving order)
    function getSelectedCourses() {
      const select = document.getElementById("courseSelect");
      const ids = Array.from(select.selectedOptions).map(opt => opt.value);
      return ids.map(id => COURSE_DATA.find(c => c.id === id));
    }

    // Clear any markers from the map
    function clearMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    // Add markers for each selected course
    function addMarkersForCourses(courses) {
      clearMarkers();
      courses.forEach((course, index) => {
        const marker = new google.maps.Marker({
          position: { lat: course.lat, lng: course.lng },
          map,
          label: String(index + 1),
          title: course.name,
        });
        markers.push(marker);
      });
    }

    // Fit the map bounds to include all selected courses
    function fitMapToCourses(courses) {
      if (courses.length === 0) return;
      const bounds = new google.maps.LatLngBounds();
      courses.forEach(course => {
        bounds.extend({ lat: course.lat, lng: course.lng });
      });
      map.fitBounds(bounds);
    }

    // Build walking route using Google Directions API
    function showRoute() {
      const selectedCourses = getSelectedCourses();

      if (selectedCourses.length < 2) {
        alert("Select at least 2 courses to show a walking route.");
        return;
      }

      addMarkersForCourses(selectedCourses);
      fitMapToCourses(selectedCourses);

      const origin = {
        lat: selectedCourses[0].lat,
        lng: selectedCourses[0].lng,
      };
      const destination = {
        lat: selectedCourses[selectedCourses.length - 1].lat,
        lng: selectedCourses[selectedCourses.length - 1].lng,
      };

      // All the courses in between become waypoints
      const waypoints = selectedCourses.slice(1, -1).map(course => ({
        location: { lat: course.lat, lng: course.lng },
        stopover: true,
      }));

      const request = {
        origin,
        destination,
        waypoints,
        travelMode: google.maps.TravelMode.WALKING,
        optimizeWaypoints: false, // preserve the order user selected
      };

      directionsService.route(request, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          directionsRenderer.setDirections(result);
        } else {
          console.error("Directions request failed:", status);
          alert("Could not compute walking route: " + status);
        }
      });
    }

    // Expose showRoute globally so the button onclick can access it
    window.showRoute = showRoute;
    window.initMap = initMap;
  </script>
</head>
<body>
  <header>
    <h1>Course Mapper</h1>
    <nav>
      <a href="index.html">Course Mapper</a>
      <a href="tos.html">TOS / FAQ</a>
    </nav>
  </header>

  <main>
    <section class="sidebar">
      <h2>Select your courses</h2>
      <p>
        Choose your classes in the order you attend them. The map will show a walking route
        that connects them in that sequence.
      </p>

      <label for="courseSelect">Courses (hold Ctrl/⌘ to select multiple):</label>
      <select id="courseSelect" multiple></select>

      <button id="showRouteBtn" onclick="showRoute()" disabled>
        Show Walking Route
      </button>

      <p class="note">
        Note: Locations are example coordinates. Replace <code>COURSE_DATA</code> with real
        building locations when you’re ready.
      </p>
    </section>

    <div id="map"></div>
  </main>
</body>
</html>